<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: linear-gradient(135deg, #1a237e 0%, #283593 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        h1 {
            margin: 0 0 15px 0;
            color: white;
            font-size: 2.2rem;
        }
        
        nav ul {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        nav li {
            display: inline;
        }
        
        nav a {
            color: white;
            text-decoration: none;
            padding: 10px 18px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            display: inline-block;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        nav a:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        main {
            background: white;
            padding: 35px;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.08);
            position: relative;
            overflow: hidden;
        }
        
        main::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #1a237e, #3949ab, #1a237e);
        }
        
        main h1 {
            color: #1a237e;
            margin-bottom: 35px;
            font-size: 2.5rem;
            position: relative;
            display: inline-block;
        }
        
        main h1::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 0;
            width: 60px;
            height: 4px;
            background: #e44d26;
            border-radius: 2px;
        }
        
        .detail-container {
            display: flex;
            flex-wrap: wrap;
            gap: 50px;
            margin-bottom: 40px;
        }
        
        .detail-image {
            flex: 1;
            min-width: 300px;
            position: relative;
        }
        
        .detail-image img {
            width: 100%;
            height: auto;
            border-radius: 10px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
            transition: transform 0.3s ease;
        }
        
        .detail-image img:hover {
            transform: scale(1.02);
        }
        
        .image-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            background: #e44d26;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9rem;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .detail-info {
            flex: 1;
            min-width: 300px;
        }
        
        .detail-info h2 {
            color: #1a237e;
            margin-bottom: 20px;
            font-size: 2.2rem;
            font-weight: 700;
        }
        
        .vehicle-price {
            font-size: 2.4rem;
            color: #e44d26;
            font-weight: 800;
            margin: 25px 0;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .price-badge {
            background: #e44d26;
            color: white;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .specifications {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 25px;
            border-radius: 10px;
            margin: 25px 0;
            border-left: 5px solid #1a237e;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        
        .spec-item {
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
        }
        
        .spec-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .spec-item strong {
            display: inline-block;
            width: 160px;
            color: #1a237e;
            font-weight: 600;
        }
        
        .spec-item i {
            color: #3949ab;
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }
        
        .description {
            margin-top: 35px;
            background: white;
            padding: 25px;
            border-radius: 10px;
            border: 1px solid #e9ecef;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        
        .description h3 {
            color: #1a237e;
            margin-bottom: 15px;
            font-size: 1.4rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .description p {
            line-height: 1.8;
            color: #555;
            font-size: 1.05rem;
        }
        
        footer {
            margin-top: 50px;
            text-align: center;
            color: #666;
            padding-top: 25px;
            border-top: 1px solid #ddd;
            font-size: 0.95rem;
        }
        
        footer a {
            color: #1a237e;
            text-decoration: none;
            padding: 0 8px;
            font-weight: 600;
            transition: color 0.3s;
        }
        
        footer a:hover {
            color: #e44d26;
            text-decoration: underline;
        }
        
        /* Enhanced Review System Styles */
        .reviews-section {
            margin-top: 4rem;
            padding-top: 3rem;
            border-top: 2px solid #dee2e6;
            position: relative;
        }
        
        .reviews-section::before {
            content: 'Customer Reviews';
            position: absolute;
            top: -15px;
            left: 0;
            background: white;
            padding: 0 20px;
            color: #1a237e;
            font-size: 1.8rem;
            font-weight: 700;
        }
        
        .review-stats {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            margin-bottom: 40px;
        }
        
        .rating-summary {
            flex: 1;
            min-width: 250px;
            background: linear-gradient(135deg, #1a237e 0%, #3949ab 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(26, 35, 126, 0.2);
        }
        
        .rating-summary h4 {
            color: white;
            margin-bottom: 20px;
            font-size: 1.4rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .rating-summary h4 i {
            color: #ffc107;
        }
        
        .overall-rating {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .rating-number {
            font-size: 4rem;
            font-weight: 800;
            color: #ffc107;
            line-height: 1;
        }
        
        .rating-stars-large {
            display: flex;
            justify-content: center;
            gap: 5px;
            margin: 15px 0;
        }
        
        .star-large {
            color: #ffc107;
            font-size: 2rem;
        }
        
        .rating-count {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .rating-distribution {
            flex: 2;
            min-width: 300px;
            background: white;
            padding: 25px;
            border-radius: 12px;
            border: 1px solid #e9ecef;
            box-shadow: 0 8px 20px rgba(0,0,0,0.05);
        }
        
        .rating-bar {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .star-label {
            width: 80px;
            font-weight: 600;
            color: #1a237e;
        }
        
        .bar-container {
            flex: 1;
            height: 20px;
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            margin: 0 15px;
        }
        
        .bar {
            height: 100%;
            background: linear-gradient(90deg, #ffc107, #ff9800);
            border-radius: 10px;
            transition: width 1s ease;
        }
        
        .bar-count {
            width: 40px;
            text-align: right;
            font-weight: 600;
            color: #666;
        }
        
        .add-review-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 30px;
            border-radius: 12px;
            margin: 40px 0;
            border: 2px dashed #1a237e;
            position: relative;
            overflow: hidden;
        }
        
        .add-review-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #1a237e, #3949ab, #1a237e);
        }
        
        .review-form-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 25px;
        }
        
        .review-form-header h4 {
            color: #1a237e;
            margin: 0;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .char-count {
            color: #666;
            font-size: 0.9rem;
        }
        
        .char-count.warning {
            color: #ff9800;
        }
        
        .char-count.danger {
            color: #f44336;
        }
        
        .rating-input-enhanced {
            display: flex;
            flex-direction: row-reverse;
            justify-content: flex-start;
            margin: 20px 0 30px 0;
        }
        
        .rating-input-enhanced input[type="radio"] {
            display: none;
        }
        
        .rating-input-enhanced label {
            cursor: pointer;
            font-size: 2.2rem;
            color: #ddd;
            padding: 0 8px;
            transition: all 0.3s ease;
        }
        
        .rating-input-enhanced label:hover,
        .rating-input-enhanced label:hover ~ label,
        .rating-input-enhanced input[type="radio"]:checked ~ label {
            color: #ffc107;
            transform: scale(1.1);
        }
        
        .rating-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            color: #666;
            font-size: 0.9rem;
        }
        
        .form-group-enhanced {
            margin-bottom: 25px;
        }
        
        .form-group-enhanced label {
            display: block;
            margin-bottom: 10px;
            font-weight: 700;
            color: #333;
            font-size: 1.1rem;
        }
        
        .form-group-enhanced textarea {
            width: 100%;
            padding: 18px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-family: inherit;
            font-size: 1rem;
            transition: all 0.3s;
            resize: vertical;
            min-height: 150px;
        }
        
        .form-group-enhanced textarea:focus {
            outline: none;
            border-color: #1a237e;
            box-shadow: 0 0 0 3px rgba(26, 35, 126, 0.1);
        }
        
        .btn-enhanced {
            padding: 14px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .btn-primary-enhanced {
            background: linear-gradient(135deg, #1a237e 0%, #3949ab 100%);
            color: white;
        }
        
        .btn-primary-enhanced:hover {
            background: linear-gradient(135deg, #3949ab 0%, #1a237e 100%);
            transform: translateY(-3px);
            box-shadow: 0 8px 15px rgba(26, 35, 126, 0.3);
        }
        
        .btn-secondary-enhanced {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
            color: white;
            text-decoration: none;
        }
        
        .btn-secondary-enhanced:hover {
            background: linear-gradient(135deg, #495057 0%, #6c757d 100%);
            transform: translateY(-3px);
            box-shadow: 0 8px 15px rgba(108, 117, 125, 0.3);
        }
        
        .reviews-list-enhanced {
            margin-top: 40px;
        }
        
        .reviews-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }
        
        .reviews-header h4 {
            color: #1a237e;
            margin: 0;
            font-size: 1.6rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .sort-options {
            display: flex;
            gap: 10px;
        }
        
        .sort-btn {
            padding: 8px 16px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        
        .sort-btn:hover {
            background: #e9ecef;
        }
        
        .sort-btn.active {
            background: #1a237e;
            color: white;
            border-color: #1a237e;
        }
        
        .review-card-enhanced {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
            position: relative;
        }
        
        .review-card-enhanced:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 25px rgba(0,0,0,0.1);
            border-color: #1a237e;
        }
        
        .review-card-enhanced.verified::before {
            content: '✓ Verified Purchase';
            position: absolute;
            top: 15px;
            right: 15px;
            background: #4caf50;
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .review-header-enhanced {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }
        
        .reviewer-info-enhanced {
            flex: 1;
        }
        
        .reviewer-name {
            font-weight: 700;
            color: #1a237e;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .reviewer-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #1a237e 0%, #3949ab 100%);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.1rem;
        }
        
        .review-meta {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 8px;
            flex-wrap: wrap;
        }
        
        .review-date {
            color: #666;
            font-size: 0.9rem;
        }
        
        .review-helpful {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #666;
            font-size: 0.9rem;
        }
        
        .helpful-btn {
            background: none;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 4px 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.2s;
        }
        
        .helpful-btn:hover {
            background: #f8f9fa;
            border-color: #1a237e;
        }
        
        .helpful-btn.liked {
            background: #e8f5e9;
            border-color: #4caf50;
            color: #2e7d32;
        }
        
        .review-rating-enhanced {
            display: flex;
            gap: 3px;
            margin-top: 5px;
        }
        
        .review-text-enhanced {
            line-height: 1.8;
            color: #444;
            margin-bottom: 20px;
            font-size: 1.05rem;
        }
        
        .review-actions-enhanced {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 20px;
            border-top: 1px solid #f0f0f0;
        }
        
        .review-tags {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .review-tag {
            background: #f0f0f0;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.85rem;
            color: #666;
        }
        
        .user-review-notice {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            padding: 25px;
            border-radius: 12px;
            margin: 30px 0;
            border: 2px solid #1a237e;
            position: relative;
        }
        
        .user-review-notice h4 {
            color: #1a237e;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .pagination {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 40px;
        }
        
        .page-btn {
            padding: 10px 16px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .page-btn:hover {
            background: #e9ecef;
        }
        
        .page-btn.active {
            background: #1a237e;
            color: white;
            border-color: #1a237e;
        }
        
        .no-reviews-enhanced {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }
        
        .no-reviews-enhanced i {
            font-size: 4rem;
            color: #dee2e6;
            margin-bottom: 20px;
        }
        
        .no-reviews-enhanced h4 {
            color: #1a237e;
            margin-bottom: 10px;
            font-size: 1.4rem;
        }
        
        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .review-card-enhanced {
            animation: fadeIn 0.5s ease forwards;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .detail-container {
                flex-direction: column;
                gap: 30px;
            }
            
            body {
                padding: 15px;
            }
            
            main {
                padding: 25px;
            }
            
            .review-stats {
                flex-direction: column;
            }
            
            .review-header-enhanced {
                flex-direction: column;
                gap: 15px;
            }
            
            .review-actions-enhanced {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }
            
            .rating-input-enhanced label {
                font-size: 1.8rem;
                padding: 0 5px;
            }
        }
        
        @media (max-width: 480px) {
            nav ul {
                flex-direction: column;
                gap: 8px;
            }
            
            .spec-item strong {
                width: 120px;
            }
            
            .rating-number {
                font-size: 3rem;
            }
            
            .btn-enhanced {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1><i class="fas fa-car"></i> CSE Motors</h1>
        <nav>
            <%- nav %>
        </nav>
    </header>
    
    <main>
        <h1><%= title %></h1>
        
        <% if (messages && messages.length > 0) { %>
            <div class="success-message" style="
                background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
                color: #2e7d32;
                padding: 20px;
                border-radius: 8px;
                border-left: 5px solid #2e7d32;
                margin: 20px 0;
                box-shadow: 0 4px 12px rgba(46, 125, 50, 0.1);
                animation: fadeIn 0.5s ease;
            ">
                <% messages.forEach(message => { %>
                    <p><i class="fas fa-check-circle"></i> <%= message %></p>
                <% }); %>
            </div>
        <% } %>
        
        <% if (errors && errors.length > 0) { %>
            <div class="error-message" style="
                background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
                color: #c62828;
                padding: 20px;
                border-radius: 8px;
                border-left: 5px solid #c62828;
                margin: 20px 0;
                box-shadow: 0 4px 12px rgba(198, 40, 40, 0.1);
                animation: fadeIn 0.5s ease;
            ">
                <ul>
                    <% errors.forEach(error => { %>
                        <li><i class="fas fa-exclamation-circle"></i> <%= error.msg || error %></li>
                    <% }); %>
                </ul>
            </div>
        <% } %>
        
        <%- detailHTML %>
        
        <!-- Enhanced Reviews Section -->
        <div class="reviews-section">
            <!-- Review Statistics -->
            <div class="review-stats">
                <div class="rating-summary">
                    <h4><i class="fas fa-star"></i> Overall Rating</h4>
                    <div class="overall-rating">
                        <div class="rating-number">
                            <%= averageRating && averageRating.average_rating ? averageRating.average_rating.toFixed(1) : '0.0' %>
                        </div>
                        <div class="rating-stars-large">
                            <% for(let i = 1; i <= 5; i++) { %>
                                <span class="star-large <%= i <= Math.round(averageRating?.average_rating || 0) ? 'filled' : '' %>">★</span>
                            <% } %>
                        </div>
                        <div class="rating-count">
                            Based on <%= averageRating?.review_count || 0 %> review<%= (averageRating?.review_count || 0) !== 1 ? 's' : '' %>
                        </div>
                    </div>
                </div>
                
                <!-- Rating Distribution -->
                <div class="rating-distribution">
                    <h4 style="color: #1a237e; margin-bottom: 20px; font-size: 1.4rem;">
                        <i class="fas fa-chart-bar"></i> Rating Distribution
                    </h4>
                    <% 
                    // Calculate rating distribution
                    const ratingCounts = {5: 0, 4: 0, 3: 0, 2: 0, 1: 0};
                    if (reviews && reviews.length > 0) {
                        reviews.forEach(review => {
                            ratingCounts[review.review_rating] = (ratingCounts[review.review_rating] || 0) + 1;
                        });
                    }
                    
                    const totalReviews = reviews ? reviews.length : 0;
                    %>
                    
                    <% for(let rating = 5; rating >= 1; rating--) { 
                        const count = ratingCounts[rating] || 0;
                        const percentage = totalReviews > 0 ? (count / totalReviews * 100) : 0;
                    %>
                        <div class="rating-bar">
                            <div class="star-label">
                                <% for(let i = 1; i <= rating; i++) { %>★<% } %>
                            </div>
                            <div class="bar-container">
                                <div class="bar" style="width: <%= percentage %>%"></div>
                            </div>
                            <div class="bar-count"><%= count %></div>
                        </div>
                    <% } %>
                </div>
            </div>
            
            <!-- Add Review Section -->
            <% if (loggedin && !userHasReviewed) { %>
                <div class="add-review-card">
                    <div class="review-form-header">
                        <h4><i class="fas fa-edit"></i> Write Your Review</h4>
                        <div class="char-count">0/1000</div>
                    </div>
                    
                    <form id="reviewForm" action="/review/add" method="post">
                        <input type="hidden" name="inv_id" value="<%= vehicle.inv_id %>">
                        
                        <!-- Rating Input -->
                        <div class="form-group-enhanced">
                            <label>How would you rate this vehicle?</label>
                            <div class="rating-input-enhanced">
                                <% for(let i = 5; i >= 1; i--) { %>
                                    <input type="radio" id="star<%= i %>" name="review_rating" value="<%= i %>" required>
                                    <label for="star<%= i %>" title="<%= i %> star<%= i !== 1 ? 's' : '' %>">★</label>
                                <% } %>
                            </div>
                            <div class="rating-labels">
                                <span>Poor</span>
                                <span>Fair</span>
                                <span>Good</span>
                                <span>Very Good</span>
                                <span>Excellent</span>
                            </div>
                        </div>
                        
                        <!-- Review Text -->
                        <div class="form-group-enhanced">
                            <label for="review_text">Your Detailed Review</label>
                            <textarea id="review_text" name="review_text" rows="6" required 
                                      placeholder="Share your experience with this vehicle. What features did you like? How was the performance? Would you recommend it to others?"
                                      maxlength="1000"></textarea>
                        </div>
                        
                        <!-- Review Tags (Optional) -->
                        <div class="form-group-enhanced">
                            <label>Select tags that apply (optional):</label>
                            <div class="review-tags">
                                <% const tags = ['Great Performance', 'Good Value', 'Comfortable', 'Fuel Efficient', 'Reliable', 'Stylish', 'Spacious', 'High Tech']; %>
                                <% tags.forEach(tag => { %>
                                    <label class="review-tag" style="cursor: pointer;">
                                        <input type="checkbox" name="review_tags" value="<%= tag.toLowerCase().replace(' ', '_') %>" style="margin-right: 5px;">
                                        <%= tag %>
                                    </label>
                                <% }) %>
                            </div>
                        </div>
                        
                        <button type="submit" class="btn-enhanced btn-primary-enhanced">
                            <i class="fas fa-paper-plane"></i> Submit Review
                        </button>
                    </form>
                </div>
            <% } else if (loggedin && userHasReviewed && existingUserReview) { %>
                <!-- User's Existing Review -->
                <div class="user-review-notice">
                    <h4><i class="fas fa-user-check"></i> Your Review</h4>
                    <p>You reviewed this vehicle on <strong><%= new Date(existingUserReview.review_date).toLocaleDateString('en-US', { 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric' 
                    }) %></strong>. You can edit or delete your review below.</p>
                    
                    <!-- Edit Review Form -->
                    <form action="/review/update" method="post" style="margin-top: 20px;">
                        <input type="hidden" name="review_id" value="<%= existingUserReview.review_id %>">
                        <input type="hidden" name="inv_id" value="<%= vehicle.inv_id %>">
                        
                        <div class="form-group-enhanced">
                            <label>Update Your Rating:</label>
                            <div class="rating-input-enhanced">
                                <% for(let i = 5; i >= 1; i--) { %>
                                    <input type="radio" id="editStar<%= i %>" 
                                           name="review_rating" 
                                           value="<%= i %>" 
                                           <%= i == existingUserReview.review_rating ? 'checked' : '' %> 
                                           required>
                                    <label for="editStar<%= i %>">★</label>
                                <% } %>
                            </div>
                        </div>
                        
                        <div class="form-group-enhanced">
                            <label for="edit_review_text">Update Your Review:</label>
                            <textarea id="edit_review_text" name="review_text" rows="4" required 
                                      maxlength="1000"><%= existingUserReview.review_text %></textarea>
                        </div>
                        
                        <div style="display: flex; gap: 15px; margin-top: 20px;">
                            <button type="submit" class="btn-enhanced btn-primary-enhanced">
                                <i class="fas fa-save"></i> Update Review
                            </button>
                            
                            <form action="/review/delete" method="post" style="display: inline;" 
                                  onsubmit="return confirm('Are you sure you want to delete your review? This action cannot be undone.')">
                                <input type="hidden" name="review_id" value="<%= existingUserReview.review_id %>">
                                <input type="hidden" name="inv_id" value="<%= vehicle.inv_id %>">
                                <button type="submit" class="btn-enhanced" style="
                                    background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
                                    color: white;
                                ">
                                    <i class="fas fa-trash"></i> Delete Review
                                </button>
                            </form>
                        </div>
                    </form>
                </div>
            <% } else if (!loggedin) { %>
                <div class="login-prompt" style="
                    background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
                    padding: 25px;
                    border-radius: 12px;
                    text-align: center;
                    margin: 30px 0;
                    border: 2px solid #ff9800;
                ">
                    <h4 style="color: #ff9800; margin-bottom: 15px;">
                        <i class="fas fa-sign-in-alt"></i> Join the Conversation
                    </h4>
                    <p style="font-size: 1.1rem; margin-bottom: 20px;">
                        Share your thoughts about this vehicle! Your review helps other customers make informed decisions.
                    </p>
                    <a href="/account/login" class="btn-enhanced btn-primary-enhanced" style="
                        background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
                    ">
                        <i class="fas fa-user"></i> Log In to Write a Review
                    </a>
                    <p style="margin-top: 15px; color: #666; font-size: 0.95rem;">
                        Don't have an account? <a href="/account/register" style="color: #1a237e; font-weight: 600;">Sign up here</a>
                    </p>
                </div>
            <% } %>
            
            <!-- Reviews List -->
            <div class="reviews-list-enhanced">
                <div class="reviews-header">
                    <h4><i class="fas fa-comments"></i> Customer Reviews</h4>
                    
                    <% if (reviews && reviews.length > 5) { %>
                        <div class="sort-options">
                            <button class="sort-btn active" data-sort="newest">Newest First</button>
                            <button class="sort-btn" data-sort="highest">Highest Rated</button>
                            <button class="sort-btn" data-sort="helpful">Most Helpful</button>
                        </div>
                    <% } %>
                </div>
                
                <% 
                // Filter out user's own review if they have one
                const otherReviews = reviews ? reviews.filter(review => {
                    if (!loggedin || !accountData) return true;
                    return review.account_id !== accountData.account_id;
                }) : [];
                %>
                
                <% if (otherReviews.length > 0) { %>
                    <div id="reviewsContainer">
                        <% otherReviews.forEach((review, index) => { 
                            // Generate random helpful count for demo
                            const helpfulCount = Math.floor(Math.random() * 50);
                            const isVerified = Math.random() > 0.5;
                        %>
                            <div class="review-card-enhanced <%= isVerified ? 'verified' : '' %>" data-rating="<%= review.review_rating %>" data-date="<%= new Date(review.review_date).getTime() %>">
                                <div class="review-header-enhanced">
                                    <div class="reviewer-info-enhanced">
                                        <div class="reviewer-name">
                                            <div class="reviewer-avatar">
                                                <%= review.account_firstname.charAt(0) %><%= review.account_lastname.charAt(0) %>
                                            </div>
                                            <%= review.account_firstname %> <%= review.account_lastname %>
                                        </div>
                                        <div class="review-meta">
                                            <div class="review-rating-enhanced">
                                                <% for(let i = 1; i <= 5; i++) { %>
                                                    <span class="star <%= i <= review.review_rating ? 'filled' : '' %>" style="color: #ffc107; font-size: 1.1rem;">★</span>
                                                <% } %>
                                            </div>
                                            <div class="review-date">
                                                <i class="far fa-calendar"></i> <%= new Date(review.review_date).toLocaleDateString('en-US', { 
                                                    year: 'numeric', 
                                                    month: 'short', 
                                                    day: 'numeric' 
                                                }) %>
                                            </div>
                                            <div class="review-helpful">
                                                <button class="helpful-btn" data-review="<%= review.review_id %>">
                                                    <i class="fas fa-thumbs-up"></i> Helpful
                                                    <span class="helpful-count"><%= helpfulCount %></span>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="review-text-enhanced">
                                    <%= review.review_text %>
                                </div>
                                
                                <div class="review-actions-enhanced">
                                    <div class="review-tags">
                                        <!-- Demo tags - in real implementation, these would come from database -->
                                        <% const demoTags = ['Great Performance', 'Comfortable', 'Good Value'].slice(0, Math.floor(Math.random() * 3) + 1); %>
                                        <% demoTags.forEach(tag => { %>
                                            <span class="review-tag"><%= tag %></span>
                                        <% }) %>
                                    </div>
                                    
                                    <% if (loggedin && accountData && accountData.account_id == review.account_id) { %>
                                        <div style="display: flex; gap: 10px;">
                                            <form action="/review/update" method="post" style="display: inline;">
                                                <input type="hidden" name="review_id" value="<%= review.review_id %>">
                                                <input type="hidden" name="inv_id" value="<%= vehicle.inv_id %>">
                                                <input type="hidden" name="review_rating" value="<%= review.review_rating %>">
                                                <input type="hidden" name="review_text" value="<%= review.review_text %>">
                                                <button type="submit" class="btn-edit" style="padding: 8px 16px; font-size: 0.9rem;">
                                                    <i class="fas fa-edit"></i> Edit
                                                </button>
                                            </form>
                                            
                                            <form action="/review/delete" method="post" style="display: inline;" 
                                                  onsubmit="return confirm('Are you sure you want to delete this review?')">
                                                <input type="hidden" name="review_id" value="<%= review.review_id %>">
                                                <input type="hidden" name="inv_id" value="<%= vehicle.inv_id %>">
                                                <button type="submit" class="btn-delete" style="padding: 8px 16px; font-size: 0.9rem;">
                                                    <i class="fas fa-trash"></i> Delete
                                                </button>
                                            </form>
                                        </div>
                                    <% } %>
                                </div>
                            </div>
                        <% }) %>
                    </div>
                    
                    <% if (otherReviews.length > 5) { %>
                        <div class="pagination">
                            <button class="page-btn active">1</button>
                            <button class="page-btn">2</button>
                            <button class="page-btn">3</button>
                            <span style="padding: 10px 16px; color: #666;">...</span>
                            <button class="page-btn">Next</button>
                        </div>
                    <% } %>
                    
                <% } else if (userHasReviewed) { %>
                    <div class="no-reviews-enhanced">
                        <i class="fas fa-users"></i>
                        <h4>You're the First Reviewer!</h4>
                        <p>Your review is currently the only one for this vehicle. Check back later to see what others think!</p>
                    </div>
                <% } else { %>
                    <div class="no-reviews-enhanced">
                        <i class="far fa-comment-dots"></i>
                        <h4>No Reviews Yet</h4>
                        <p>Be the first to share your thoughts about this vehicle!</p>
                    </div>
                <% } %>
            </div>
        </div>
        
        <p style="text-align: center; margin-top: 40px;">
            <a href="javascript:history.back()" class="btn-enhanced btn-secondary-enhanced">
                <i class="fas fa-arrow-left"></i> Back to Inventory
            </a>
        </p>
    </main>
    
    <footer>
        <p>© 2023 CSE Motors. All rights reserved.</p>
        <p>
            <a href="/"><i class="fas fa-home"></i> Home</a> | 
            <a href="/inv/trigger-error"><i class="fas fa-bug"></i> Test 500 Error</a> |
            <a href="/account/login"><i class="fas fa-user"></i> Account</a>
        </p>
        <p style="margin-top: 10px; font-size: 0.9rem; color: #999;">
            <i class="fas fa-shield-alt"></i> Secure Shopping | 
            <i class="fas fa-truck"></i> Free Shipping | 
            <i class="fas fa-headset"></i> 24/7 Support
        </p>
    </footer>

    <script>
        // Enhanced JavaScript for the review system
        document.addEventListener('DOMContentLoaded', function() {
            // Character counter for review text
            const reviewTextarea = document.getElementById('review_text');
            const charCount = document.querySelector('.char-count');
            
            if (reviewTextarea && charCount) {
                reviewTextarea.addEventListener('input', function() {
                    const length = this.value.length;
                    charCount.textContent = `${length}/1000`;
                    
                    if (length > 900) {
                        charCount.classList.add('warning');
                        charCount.classList.remove('danger');
                    } else if (length > 950) {
                        charCount.classList.remove('warning');
                        charCount.classList.add('danger');
                    } else {
                        charCount.classList.remove('warning', 'danger');
                    }
                });
            }
            
            // Star rating hover effects
            const ratingInputs = document.querySelectorAll('.rating-input-enhanced');
            ratingInputs.forEach(inputGroup => {
                const labels = inputGroup.querySelectorAll('label');
                const radios = inputGroup.querySelectorAll('input[type="radio"]');
                
                labels.forEach(label => {
                    label.addEventListener('mouseenter', function() {
                        const index = Array.from(labels).indexOf(this);
                        labels.forEach((l, i) => {
                            if (i <= index) {
                                l.style.transform = 'scale(1.2)';
                            } else {
                                l.style.transform = 'scale(1)';
                            }
                        });
                    });
                    
                    label.addEventListener('mouseleave', function() {
                        updateStarColors(labels, radios);
                    });
                });
                
                radios.forEach(radio => {
                    radio.addEventListener('change', function() {
                        updateStarColors(labels, radios);
                    });
                });
                
                // Initialize star colors
                updateStarColors(labels, radios);
            });
            
            // Helpful button functionality
            const helpfulBtns = document.querySelectorAll('.helpful-btn');
            helpfulBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const countSpan = this.querySelector('.helpful-count');
                    let count = parseInt(countSpan.textContent);
                    
                    if (this.classList.contains('liked')) {
                        count--;
                        this.classList.remove('liked');
                        this.innerHTML = '<i class="fas fa-thumbs-up"></i> Helpful <span class="helpful-count">' + count + '</span>';
                    } else {
                        count++;
                        this.classList.add('liked');
                        this.innerHTML = '<i class="fas fa-thumbs-up"></i> Helpful <span class="helpful-count">' + count + '</span>';
                    }
                    
                    // In a real app, you would send this to the server
                    console.log('Marked review as helpful:', this.dataset.review);
                });
            });
            
            // Sort functionality
            const sortBtns = document.querySelectorAll('.sort-btn');
            sortBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    // Remove active class from all buttons
                    sortBtns.forEach(b => b.classList.remove('active'));
                    // Add active class to clicked button
                    this.classList.add('active');
                    
                    const sortType = this.dataset.sort;
                    const reviewsContainer = document.getElementById('reviewsContainer');
                    
                    if (reviewsContainer) {
                        const reviews = Array.from(reviewsContainer.children);
                        
                        reviews.sort((a, b) => {
                            const aRating = parseInt(a.dataset.rating);
                            const bRating = parseInt(b.dataset.rating);
                            const aDate = parseInt(a.dataset.date);
                            const bDate = parseInt(b.dataset.date);
                            
                            switch(sortType) {
                                case 'newest':
                                    return bDate - aDate;
                                case 'highest':
                                    return bRating - aRating;
                                case 'helpful':
                                    // For demo, randomize
                                    return Math.random() - 0.5;
                                default:
                                    return 0;
                            }
                        });
                        
                        // Clear and re-append sorted reviews
                        reviewsContainer.innerHTML = '';
                        reviews.forEach(review => {
                            reviewsContainer.appendChild(review);
                        });
                    }
                });
            });
            
            // Form validation
            const reviewForm = document.getElementById('reviewForm');
            if (reviewForm) {
                reviewForm.addEventListener('submit', function(e) {
                    const ratingInput = this.querySelector('input[name="review_rating"]:checked');
                    const textarea = this.querySelector('textarea[name="review_text"]');
                    
                    if (!ratingInput) {
                        e.preventDefault();
                        showNotification('Please select a star rating before submitting.', 'error');
                        return false;
                    }
                    
                    if (!textarea.value.trim() || textarea.value.trim().length < 20) {
                        e.preventDefault();
                        showNotification('Please write a review of at least 20 characters.', 'error');
                        textarea.focus();
                        return false;
                    }
                    
                    // Show loading state
                    const submitBtn = this.querySelector('button[type="submit"]');
                    const originalText = submitBtn.innerHTML;
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';
                    submitBtn.disabled = true;
                    
                    // In a real app, you would use AJAX here
                    setTimeout(() => {
                        submitBtn.innerHTML = originalText;
                        submitBtn.disabled = false;
                    }, 2000);
                });
            }
            
            // Page animation on scroll
            const observerOptions = {
                threshold: 0.1,
                rootMargin: '0px 0px -50px 0px'
            };
            
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.style.opacity = '1';
                        entry.target.style.transform = 'translateY(0)';
                    }
                });
            }, observerOptions);
            
            // Observe review cards for animation
            document.querySelectorAll('.review-card-enhanced').forEach(card => {
                card.style.opacity = '0';
                card.style.transform = 'translateY(20px)';
                card.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
                observer.observe(card);
            });
            
            // Smooth scroll to reviews section if there are errors
            if (document.querySelector('.error-message')) {
                setTimeout(() => {
                    document.querySelector('.reviews-section').scrollIntoView({
                        behavior: 'smooth'
                    });
                }, 500);
            }
        });
        
        function updateStarColors(labels, radios) {
            let checkedIndex = -1;
            radios.forEach((radio, i) => {
                if (radio.checked) checkedIndex = i;
            });
            
            labels.forEach((l, i) => {
                if (i <= checkedIndex) {
                    l.style.color = '#ffc107';
                    l.style.transform = 'scale(1.1)';
                } else {
                    l.style.color = '#ddd';
                    l.style.transform = 'scale(1)';
                }
            });
        }
        
        function showNotification(message, type) {
            // Remove existing notification
            const existingNotification = document.querySelector('.notification');
            if (existingNotification) {
                existingNotification.remove();
            }
            
            // Create notification
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 25px;
                background: ${type === 'error' ? '#f44336' : '#4caf50'};
                color: white;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 1000;
                animation: slideIn 0.3s ease;
                display: flex;
                align-items: center;
                gap: 10px;
            `;
            
            notification.innerHTML = `
                <i class="fas fa-${type === 'error' ? 'exclamation-triangle' : 'check-circle'}"></i>
                <span>${message}</span>
            `;
            
            document.body.appendChild(notification);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 5000);
            
            // Add CSS for animations
            if (!document.querySelector('#notification-styles')) {
                const style = document.createElement('style');
                style.id = 'notification-styles';
                style.textContent = `
                    @keyframes slideIn {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                    @keyframes slideOut {
                        from { transform: translateX(0); opacity: 1; }
                        to { transform: translateX(100%); opacity: 0; }
                    }
                `;
                document.head.appendChild(style);
            }
        }
        
        // Share functionality
        function shareReview() {
            if (navigator.share) {
                navigator.share({
                    title: 'Check out this vehicle review on CSE Motors',
                    text: 'I found this great review on CSE Motors',
                    url: window.location.href
                });
            } else {
                // Fallback for browsers that don't support Web Share API
                const shareUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent('Check out this vehicle on CSE Motors')}&url=${encodeURIComponent(window.location.href)}`;
                window.open(shareUrl, '_blank');
            }
        }
        
        // Add share button event listeners
        document.querySelectorAll('.share-btn').forEach(btn => {
            btn.addEventListener('click', shareReview);
        });
    </script>
</body>
</html>